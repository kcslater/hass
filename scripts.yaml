# GENERAL
good_morning:
  alias: "Good Morning"
  sequence:
    - service: light.turn_on
      data:
        entity_id: light.bedroom_lights
        brightness_pct: 100
    - service: input_boolean.turn_off
      entity_id: input_boolean.sleeping

lock_if_closed:
  alias: "Lock The Door"
  sequence:
    - condition: state
      entity_id: binary_sensor.front_door
      state: 'off'
    - service: lock.lock
      entity_id: lock.home_door_lock

everything_off:
  alias: "Everything Off"
  sequence:
    - service: homeassistant.turn_off
      entity_id: group.bedroom
    - service: homeassistant.turn_off
      entity_id: group.upstairs
    - service: cover.close_cover
      entity_id: cover.garage_door_2
    - condition: state
      entity_id: input_boolean.guests_visiting
      state: 'off'
    - service: homeassistant.turn_off
      entity_id: group.downstairs

goodnight:
  alias: "Goodnight"
  sequence:
    - service: media_player.volume_set
      data:
        entity_id: media_player.bedroom
        volume_level: 0.03
    - service: input_boolean.turn_on
      entity_id: input_boolean.sleeping
    - service: script.lock_if_closed
    - service: script.everything_off
    - service: alarm_control_panel.alarm_arm_home
      entity_id: alarm_control_panel.abode_alarm
    - delay: 00:00:10
    - service: media_player.volume_set
      data:
        entity_id: media_player.bedroom
        volume_level: 0.2

time_for_bed:
  alias: "Time For Bed"
  sequence:
    - service: input_boolean.turn_on
      entity_id: input_boolean.sleeping
    - service: light.turn_on
      entity_id: light.bedroom_lights
    - service: alarm_control_panel.alarm_arm_home
      entity_id: alarm_control_panel.abode_alarm
    - service: script.lock_if_closed
    - service: homeassistant.turn_off
      entity_id: group.upstairs
    - service: cover.close_cover
      entity_id: cover.garage_door_2
    - condition: state
      entity_id: input_boolean.guests_visiting
      state: 'off'
    - service: homeassistant.turn_off
      entity_id: group.downstairs

tv_time:
  alias: "TV Time"
  sequence:
    - service: homeassistant.turn_off
      entity_id: group.upstairs
    - service: cover.close_cover
      entity_id: cover.garage_door_2
    - service: homeassistant.turn_off
      entity_id: group.bedroom
    - service: light.turn_off
      entity_id: light.basement_lights
    - service: media_player.turn_on
      entity_id: media_player.guest_room_stereo_main
    - service: media_player.select_source
      data:
        entity_id: media_player.guest_room_stereo_main
        source: 'tv'

goodbye:
  alias: "Goodbye"
  sequence:
    - service: alarm_control_panel.alarm_arm_away
      entity_id: alarm_control_panel.abode_alarm
    - service: input_boolean.turn_off
      entity_id: input_boolean.sleeping
    - service: script.lock_if_closed
    - service: script.everything_off
    # in case of guests
    - service: homeassistant.turn_off
      entity_id: group.downstairs

standby:
  alias: "Standby"
  sequence:
    - service: alarm_control_panel.alarm_disarm
      entity_id: alarm_control_panel.abode_alarm

# SPECIAL MUSIC
turntable:
  alias: "Turntable"
  sequence:
    - service: media_player.turn_on
      data:
        entity_id: media_player.living_room_stereo_main
    - delay: '00:00:02'
    - service: media_player.select_source
      data:
        entity_id: media_player.living_room_stereo_main
        source: phono
    - service: media_player.volume_set
      data:
        entity_id: media_player.living_room_stereo_main
        volume_level: 0.6
streaming:
  alias: "Streaming"
  sequence:
    - service: media_player.turn_on
      data:
        entity_id: media_player.living_room_stereo_main
    - delay: '00:00:02'
    - service: media_player.select_source
      data:
        entity_id: media_player.living_room_stereo_main
        source: spotify
    - service: media_player.volume_set
      data:
        entity_id: media_player.living_room_stereo_main
        volume_level: 0.55
close_garage:
  alias: "Close Garage"
  sequence:
    - service: cover.close_cover
      entity_id: cover.garage_door_2

switch_to_tv:
  alias: "Switch to TV"
  sequence:
    - service: media_player.select_source
      data:
        entity_id: media_player.guest_room_stereo_main
        source: "tv"

### SONOS SCRIPTS

sonos_group:
  alias: "Sonos Group"
  sequence:
    - condition: template
      value_template: >
        {% if target_player is not none and target_player != false and target_player != '' %}
          true
        {% else %}
          false
        {% endif %}
   
    # The target player must not be playing anything
    - condition: template
      value_template: >
        {% if states(target_player) != 'playing' %}
          true
        {% else %}
          false
        {% endif %}
   
    # First join the player into the group
    - service: sonos.join
      data_template:
        master: media_player.{{ states('input_select.music_controller') }}
        entity_id: >
          {% if target_player is not none %}
            {{ target_player }}
          {% endif %}
    
    # Now set the target player to the same volume as the controller
    - service: media_player.volume_set
      data_template:
        entity_id: >
          {% if target_player is not none %}
            {{ target_player }}
          {% endif %}
        volume_level: >
          {% if target_player == 'bedroom' or target_player == 'kitchen' %}
            {{ state_attr('media_player.' + states('input_select.music_controller'), 'volume_level') }}
          {% elif target_player == 'living_room' %}
            {{ [state_attr('media_player.' + states('input_select.music_controller'), 'volume_level') + 0.4, 1]|min|round(2) }}
          {% endif %}

sonos_ungroup:
  alias: "Sonos Ungroup"
  sequence:
    - condition: template
      value_template: >
        {% if target_player is not none and target_player != false and target_player != '' %}
          true
        {% else %}
          false
        {% endif %}
   
    # The target player must be playing
    - condition: template
      value_template: >
        {% if states(target_player) == 'playing' %}
          true
        {% else %}
          false
        {% endif %}
   
    # The target must not be the co-ordinator
    - condition: template
      value_template: >
        {% if target_player != 'media_player.' + states('input_select.music_controller') %}
          true
        {% else %}
          false
        {% endif %}
    
    - service: sonos.unjoin
      data_template:
        entity_id: >
          {% if target_player is not none %}
            {{ target_player }}
          {% endif %}

sonos_group_bedroom:
  alias: "Sonos Group Bedroom"
  sequence:
    - service: script.sonos_group
      data:
        target_player: media_player.bedroom

sonos_group_kitchen:
  alias: "Sonos Group Kitchen"
  sequence:
    - service: script.sonos_group
      data:
        target_player: media_player.kitchen

sonos_group_living_room:
  alias: "Sonos Group Living Room"
  sequence:
    - service: script.sonos_group
      data:
        target_player: media_player.living_room

sonos_group_all:
  alias: "Sonos Group All"
  sequence:
    - service: script.sonos_group
      data:
        target_player: media_player.living_room
    - service: script.sonos_group
      data:
        target_player: media_player.kitchen
    - service: script.sonos_group
      data:
        target_player: media_player.bedroom

sonos_ungroup_all:
  alias: "Sonos Ungroup All"
  sequence:
    - service: sonos.unjoin
      data_template:
        entity_id: >
          {% if states('input_select.music_controller') == 'bedroom' %}
            media_player.kitchen
          {% else %}
            media_player.bedroom
          {% endif %}
    - service: sonos.unjoin
      data_template:
        entity_id: >
          {% if states('input_select.music_controller') == 'bedroom' or states('input_select.music_controller') == 'kitchen' %}
            media_player.living_room
          {% else %}
            media_player.kitchen
          {% endif %}

sonos_ungroup_bedroom:
  alias: "Sonos Ungroup Bedroom"
  sequence:
    - service: sonos.unjoin
      entity_id: media_player.bedroom

sonos_ungroup_kitchen:
  alias: "Sonos Ungroup Kitchen"
  sequence:
    - service: sonos.unjoin
      entity_id: media_player.kitchen

sonos_ungroup_living_room:
  alias: "Sonos Ungroup Living Room"
  sequence:
    - service: sonos.unjoin
      entity_id: media_player.living_room

sonos_set_controller:
  alias: "Set Music Controller"
  sequence:
    - delay: 00:00:01
    - condition: template
      value_template: >
        {{ target_player == state_attr(target_player, 'sonos_group')[0] }}
    - service: input_select.select_option
      data_template:
        option: >
          {{ target_player.replace('media_player.', '') }}
      entity_id: input_select.music_controller
