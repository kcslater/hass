  - alias: 'When Last Person Leaves, Away'
    trigger:
      - platform: state
        entity_id: group.all_present
        to: 'off'
    condition:
      - condition: state
        entity_id: input_boolean.guests_visiting
        state: 'off'
    action:
      - service: alarm_control_panel.alarm_arm_away
        entity_id: alarm_control_panel.abode

  - alias: 'When Anyone Arrives, Standby'
    trigger:
      - platform: state
        entity_id: input_boolean.k_present
        to: 'on'
      - platform: state
        entity_id: input_boolean.m_present
        to: 'on'
    action:
      - service: alarm_control_panel.alarm_disarm
        entity_id: alarm_control_panel.abode

  - alias: 'When Anyone Arrives After Sunset, Porch Light'
    trigger:
      - platform: state
        entity_id: input_boolean.k_present
        to: 'on'
      - platform: state
        entity_id: input_boolean.m_present
        to: 'on'
    condition:
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'
    action:
      - service: light.turn_on
        entity_id: light.front_door
      - delay: 00:15
      - service: light.turn_off
        entity_id: light.front_door

  - alias: 'When First Person Arrives After Sunset, Living Room Light'
    trigger:
      - platform: state
        entity_id: group.all_present
        to: 'on'
    condition:
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'
      - condition: time
        before: '22:00:00'
    action:
      service: light.turn_on
      entity_id: light.living_room

  - alias: '5 AM Present, Standby'
    trigger:
      - platform: time
        at: '05:00:00'
    condition:
      - condition: state
        entity_id: group.all_present
        state: 'on'
    action:
      - service: alarm_control_panel.alarm_disarm
        entity_id: alarm_control_panel.abode

  - alias: '11 PM Present, Home'
    trigger:
      - platform: time
        at: '23:00:00'
    condition:
      - condition: state
        entity_id: group.all_present
        state: 'on'
    action:
      - service: alarm_control_panel.alarm_arm_home
        entity_id: alarm_control_panel.abode

  - alias: '2 AM Away, Everything Off'
    trigger:
      - platform: time
        at: '02:00:00'
    condition:
      - condition: state
        entity_id: group.all_present
        state: 'off'
      - condition: state
        entity_id: input_boolean.guests_visiting
        state: 'off'
    action:
      - service: script.turn_on
        entity_id: script.everything_off

# Turns off TV if Guest Room Stereo turns off
 - alias: 'Soundbar off -> TV off'
    trigger:
     - platform: state
        entity_id: media_player.guest_room_stereo_main
        to: 'off'
    action:
     - service: media_player.turn_off
        entity_id: media_player.vizio_smartcast

# Switches Spotify to Stereo if Stereo turns on
  - alias: 'Stereo On -> Spotify on Stereo'
    trigger:
      - platform: state
        entity_id: media_player.living_room_stereo_main
        from: 'off'
      - platform: state
        entity_id: media_player.kitchen_stereo_main
        from: 'off'
      - platform: state
        entity_id: media_player.bedroom_stereo_main
        from: 'off'
      - platform: state
        entity_id: media_player.basement_stereo_main
        from: 'off'
    condition:
      - condition: state
        entity_id: media_player.spotify
        state: 'playing'
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.spotify_source
            state: 'Kitchen Stereo'
          - condition: state
            entity_id: sensor.spotify_source
            state: 'Bedroom Stereo'
          - condition: state
            entity_id: sensor.spotify_source
            state: 'Basement Stereo'
          - condition: state
            entity_id: sensor.spotify_source
            state: 'Guest Room Stereo'
    action:
      - service: script.turn_on
        data_template:
          entity_id: >
            script.spotify_{{ trigger.entity_id.replace("media_player.", "").replace("_stereo_main", "") }}

# Switch Spotify (long, redundant stuff commented out)
  - alias: 'Spotify on Echo -> Spotify on Stereo'
    trigger:
    #   - platform: state
    #     entity_id: media_player.spotify
    #     to: 'playing'
      - platform: state
        entity_id: sensor.spotify_source
        to: 'Kitchen Echo Dot'
      - platform: state
        entity_id: sensor.spotify_source
        to: 'Bedroom Echo Dot'
      - platform: state
        entity_id: sensor.spotify_source
        to: 'Living Room Echo Dot'
      - platform: state
        entity_id: sensor.spotify_source
        to: 'Guest Room Echo Dot'
    # condition:
    #   condition: or
    #   conditions:
    #     - condition: state
    #       entity_id: sensor.spotify_source
    #       state: 'Kitchen Echo Dot'
    #     - condition: state
    #       entity_id: sensor.spotify_source
    #       state: 'Bedroom Echo Dot'
    #     - condition: state
    #       entity_id: sensor.spotify_source
    #       state: 'Living Room Echo Dot'
    #     - condition: state
    #       entity_id: sensor.spotify_source
    #       state: 'Guest Room Echo Dot'
    action:
      - service: script.turn_on
        data_template:
          entity_id: >
            script.spotify_{{ states("sensor.spotify_source").replace(" Echo Dot", "").replace(" ","_").lower() }}

# old scripts
arrive_home_helper:
  alias: "Arrive Home LR Lights"
  sequence:
    - condition: time
      before: '22:00:00'
    - condition: state
      entity_id: input_boolean.entered
      state: 'off'
    - service: light.turn_on
      entity_id: light.living_room
    - service: input_boolean.turn_on
      entity_id: input_boolean.entered

arrive_home:
  alias: "Arrive Home"
  sequence:
    - service: alarm_control_panel.alarm_disarm
      entity_id: alarm_control_panel.abode
    - condition: state
      entity_id: sun.sun
      state: 'below_horizon'
    - condition: state
      entity_id: input_boolean.sleeping
      state: 'off'
    - service: script.turn_on
      entity_id: script.arrive_home_helper
    - service: light.turn_on
      entity_id: light.front_door
    - delay: 00:15
    - service: light.turn_off
      entity_id: light.front_door

shutdown:
  alias: "Shutdown"
  sequence:
    - service: input_boolean.turn_off
      entity_id: input_boolean.entered
    - service: input_boolean.turn_off
      entity_id: input_boolean.sleeping
    - service: script.turn_on
      entity_id: script.everything_off
    # in case of guests
    - service: homeassistant.turn_off
      entity_id: group.downstairs